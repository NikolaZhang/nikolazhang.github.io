import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as t,a,e,r as d,o as l}from"./app-BBLV0Jda.js";const r={};function o(h,s){const i=d("Mermaid");return l(),t("div",null,[s[0]||(s[0]=a('<h2 id="_1-简介" tabindex="-1"><a class="header-anchor" href="#_1-简介"><span>1. 简介</span></a></h2><p>Redis是一个基于内存的高性能键值数据库，内存中的数据在服务器重启后会丢失。为了解决这个问题，Redis提供了持久化机制，将内存中的数据保存到磁盘上，以便在服务器重启后能够恢复数据。</p><p>Redis支持两种主要的持久化方式：</p><ol><li><strong>RDB（Redis DataBase）</strong>：将内存中的数据以快照的形式保存到磁盘上。</li><li><strong>AOF（Append Only File）</strong>：将所有的写命令追加到日志文件中，重启时通过重新执行这些命令来恢复数据。</li></ol><p>本文将详细介绍这两种持久化方式的原理、配置、优缺点以及适用场景，并介绍Redis 4.0引入的混合持久化机制。</p><h2 id="_2-rdb持久化" tabindex="-1"><a class="header-anchor" href="#_2-rdb持久化"><span>2. RDB持久化</span></a></h2><h3 id="_2-1-rdb基本原理" tabindex="-1"><a class="header-anchor" href="#_2-1-rdb基本原理"><span>2.1 RDB基本原理</span></a></h3><p>RDB持久化是将Redis在某个时间点的内存数据快照（Snapshot）保存到磁盘上的过程。RDB文件是一个二进制文件，包含了当时内存中的所有数据。</p>',8)),e(i,{code:"eJxLL0osyFAIceFSAALH6KDUlMzip22tT9fOeDZ1w7PedbEKurp2Ck7RTztmP9296+naCS/2z36+ojsWrN4JLOkcDReGqApycXo2rf3J7m0QVc5gVS7RT9tmPm1dimI4WN4FLO8a/XRdz7OOCWiaXcGSbtHPZu9/1rvo2fTlSPIA8lpXbg=="}),s[1]||(s[1]=a(`<h3 id="_2-2-rdb触发方式" tabindex="-1"><a class="header-anchor" href="#_2-2-rdb触发方式"><span>2.2 RDB触发方式</span></a></h3><p>RDB持久化可以通过以下几种方式触发：</p><h4 id="_2-2-1-手动触发" tabindex="-1"><a class="header-anchor" href="#_2-2-1-手动触发"><span>2.2.1 手动触发</span></a></h4><ol><li><p><strong>SAVE命令</strong>：</p><ul><li>阻塞Redis服务器，直到RDB文件创建完成</li><li>不推荐在生产环境使用，会影响Redis的响应性能</li></ul></li><li><p><strong>BGSAVE命令</strong>：</p><ul><li>异步创建RDB文件，不会阻塞Redis服务器</li><li>Redis会fork一个子进程来创建RDB文件</li><li>生产环境推荐使用</li></ul></li></ol><h4 id="_2-2-2-自动触发" tabindex="-1"><a class="header-anchor" href="#_2-2-2-自动触发"><span>2.2.2 自动触发</span></a></h4><p>可以通过配置文件中的<code>save</code>参数来自动触发RDB持久化：</p><div class="language-conf line-numbers-mode" data-highlighter="shiki" data-ext="conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-conf"><span class="line"><span>save 900 1    # 900秒内至少有1个键被修改</span></span>
<span class="line"><span>save 300 10   # 300秒内至少有10个键被修改</span></span>
<span class="line"><span>save 60 10000 # 60秒内至少有10000个键被修改</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当满足上述条件之一时，Redis会自动执行BGSAVE命令。</p><h4 id="_2-2-3-其他触发方式" tabindex="-1"><a class="header-anchor" href="#_2-2-3-其他触发方式"><span>2.2.3 其他触发方式</span></a></h4><ol><li><strong>主从复制</strong>：从服务器全量复制时，主服务器会执行BGSAVE命令</li><li><strong>执行SHUTDOWN命令</strong>：Redis关闭时会执行SAVE命令</li><li><strong>执行FLUSHALL命令</strong>：清空所有数据时，如果开启了RDB持久化，会执行SAVE命令</li></ol><h3 id="_2-3-rdb文件结构" tabindex="-1"><a class="header-anchor" href="#_2-3-rdb文件结构"><span>2.3 RDB文件结构</span></a></h3><p>RDB文件是一个二进制文件，主要包含以下几个部分：</p>`,12)),e(i,{code:"eJxLL0osyFAIceFSAALH6CBXF8/gl2unPNs89dnUDbEKurp2Ck7RQS5Ozzs7ns1Z87R/eyxYpRNYxjkaqOhZ77qnuya/bF7xtKMNIukMlnSJfjll3dOGPU/X74Sogki6gCVdo5/vnvxs7vxnC9qf7p8OkXEFy7hFP1uw8OWqnqeTemK5AHvJRCc="}),s[2]||(s[2]=a('<ul><li><strong>REDIS魔法数</strong>：标识这是一个RDB文件</li><li><strong>RDB版本号</strong>：RDB文件的版本信息</li><li><strong>数据库部分</strong>：包含多个数据库的数据</li><li><strong>键值对数据</strong>：实际的键值对数据，使用特定的编码格式存储</li><li><strong>结束标志</strong>：标识RDB文件的结束</li><li><strong>校验和</strong>：用于验证RDB文件的完整性</li></ul><h3 id="_2-4-rdb配置参数" tabindex="-1"><a class="header-anchor" href="#_2-4-rdb配置参数"><span>2.4 RDB配置参数</span></a></h3><p>RDB持久化的主要配置参数如下：</p><table><thead><tr><th>参数</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>save</td><td>自动触发RDB持久化的条件</td><td>save 900 1 save 300 10 save 60 10000</td></tr><tr><td>dbfilename</td><td>RDB文件名</td><td>dump.rdb</td></tr><tr><td>dir</td><td>RDB文件保存目录</td><td>./</td></tr><tr><td>stop-writes-on-bgsave-error</td><td>BGSAVE失败时是否停止写入</td><td>yes</td></tr><tr><td>rdbcompression</td><td>是否压缩RDB文件</td><td>yes</td></tr><tr><td>rdbchecksum</td><td>是否对RDB文件进行校验和检查</td><td>yes</td></tr></tbody></table><h3 id="_2-5-rdb的优缺点" tabindex="-1"><a class="header-anchor" href="#_2-5-rdb的优缺点"><span>2.5 RDB的优缺点</span></a></h3><h4 id="_2-5-1-优点" tabindex="-1"><a class="header-anchor" href="#_2-5-1-优点"><span>2.5.1 优点</span></a></h4><ol><li><strong>文件体积小</strong>：RDB文件是二进制文件，体积较小，便于存储和传输</li><li><strong>恢复速度快</strong>：加载RDB文件的速度比AOF快</li><li><strong>适合备份</strong>：适合用于定期备份和灾难恢复</li><li><strong>对性能影响小</strong>：BGSAVE命令是异步执行的，对Redis的正常运行影响较小</li></ol><h4 id="_2-5-2-缺点" tabindex="-1"><a class="header-anchor" href="#_2-5-2-缺点"><span>2.5.2 缺点</span></a></h4><ol><li><strong>数据安全性低</strong>：如果在两次RDB持久化之间发生故障，会丢失这段时间内的数据</li><li><strong>fork子进程开销</strong>：BGSAVE命令会fork子进程，当数据量较大时，fork操作会占用大量内存和CPU资源</li><li><strong>不适合实时持久化</strong>：无法保证数据的实时持久化</li></ol><h2 id="_3-aof持久化" tabindex="-1"><a class="header-anchor" href="#_3-aof持久化"><span>3. AOF持久化</span></a></h2><h3 id="_3-1-aof基本原理" tabindex="-1"><a class="header-anchor" href="#_3-1-aof基本原理"><span>3.1 AOF基本原理</span></a></h3><p>AOF持久化是将Redis执行的所有写命令追加到AOF文件末尾，重启时通过重新执行这些命令来恢复数据。</p>',12)),e(i,{code:"eJxLL0osyFAIceFSAALH6KfrFj3r2P589fqnbTOfTtz7ZPeSWAVdXTsFp+hnnctfLOyBioFVO4FlnKOf7F/3bMrOp22tT9fOeDZ1w7PedRB5Z7C8S/SL/Xufdi2A6HzascHR3+35nslP2zY97dkFUegCVugKtHzWsznzn25og8tDjAO5pXUpUN+zae1Pdm+DaHIFa3KLhgs/ndDzbO1SoAXPFzc+nz0jlgsAoKNvyQ=="}),s[3]||(s[3]=a('<h3 id="_3-2-aof写入策略" tabindex="-1"><a class="header-anchor" href="#_3-2-aof写入策略"><span>3.2 AOF写入策略</span></a></h3><p>AOF持久化的写入策略由<code>appendfsync</code>参数控制：</p><table><thead><tr><th>选项</th><th>描述</th><th>安全性</th><th>性能</th></tr></thead><tbody><tr><td>always</td><td>每次写命令都立即同步到磁盘</td><td>最高</td><td>最低</td></tr><tr><td>everysec</td><td>每秒同步一次到磁盘</td><td>较高</td><td>较高</td></tr><tr><td>no</td><td>由操作系统决定何时同步</td><td>最低</td><td>最高</td></tr></tbody></table><h3 id="_3-3-aof重写机制" tabindex="-1"><a class="header-anchor" href="#_3-3-aof重写机制"><span>3.3 AOF重写机制</span></a></h3><p>随着时间的推移，AOF文件会变得越来越大，影响Redis的性能和恢复速度。为了解决这个问题，Redis提供了AOF重写机制，通过创建一个新的AOF文件来替代旧的AOF文件，新文件中只包含恢复当前数据所需的最小命令集。</p>',5)),e(i,{code:"eJxdj00OwUAUgPdO0Qu4ggRVrGzsXiysWIozUA0aBPXTBRF/G9VYdNFqepm+mbqFyZumCbOc73vvm+n0272u0lRzijhFSG5XnC2KDe0zMlHftZR8vqCUAA0bAx8f8ySy+X3SIrtEsAzZdfIMcGahPsTHlq1dZjpSLJOoAl8dmDFnlsv3A5HARRgHZ6mopFRANHF4EYrgzBrFgSd5hbgG3PDSVhTi+ChEuQUNl7+XqL9w6ssJjSaqgM5URNPvEKkSqQGzI2ae2Ob216oRr4NMZGuz0O/rvmVen7Q="}),s[4]||(s[4]=a(`<h3 id="_3-4-aof重写触发方式" tabindex="-1"><a class="header-anchor" href="#_3-4-aof重写触发方式"><span>3.4 AOF重写触发方式</span></a></h3><p>AOF重写可以通过以下几种方式触发：</p><h4 id="_3-4-1-手动触发" tabindex="-1"><a class="header-anchor" href="#_3-4-1-手动触发"><span>3.4.1 手动触发</span></a></h4><p>使用<code>BGREWRITEAOF</code>命令手动触发AOF重写：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">BGREWRITEAOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_3-4-2-自动触发" tabindex="-1"><a class="header-anchor" href="#_3-4-2-自动触发"><span>3.4.2 自动触发</span></a></h4><p>可以通过配置文件中的参数来自动触发AOF重写：</p><div class="language-conf line-numbers-mode" data-highlighter="shiki" data-ext="conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-conf"><span class="line"><span>auto-aof-rewrite-percentage 100  # AOF文件大小增长超过100%</span></span>
<span class="line"><span>auto-aof-rewrite-min-size 64mb    # AOF文件最小大小为64MB</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>当AOF文件大小超过<code>auto-aof-rewrite-min-size</code>，并且比上一次重写后的大小增长了<code>auto-aof-rewrite-percentage</code>时，自动触发AOF重写。</p><h3 id="_3-5-aof文件结构" tabindex="-1"><a class="header-anchor" href="#_3-5-aof文件结构"><span>3.5 AOF文件结构</span></a></h3><p>AOF文件是一个文本文件，包含了Redis执行的所有写命令，格式如下：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">*2</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$6</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SELECT</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">*3</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$3</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SET</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$5</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mykey</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$7</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">myvalue</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">*2</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$4</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">INCR</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$4</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">counter</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是Redis的协议格式（RESP），每条命令由多个部分组成：</p><ul><li><code>*n</code>：表示命令有n个参数</li><li><code>$m</code>：表示下一个参数的长度为m</li><li>实际的参数值</li></ul><h3 id="_3-6-aof配置参数" tabindex="-1"><a class="header-anchor" href="#_3-6-aof配置参数"><span>3.6 AOF配置参数</span></a></h3><p>AOF持久化的主要配置参数如下：</p><table><thead><tr><th>参数</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>appendonly</td><td>是否开启AOF持久化</td><td>no</td></tr><tr><td>appendfilename</td><td>AOF文件名</td><td>appendonly.aof</td></tr><tr><td>dir</td><td>AOF文件保存目录</td><td>./</td></tr><tr><td>appendfsync</td><td>AOF写入策略</td><td>everysec</td></tr><tr><td>no-appendfsync-on-rewrite</td><td>AOF重写时是否停止同步</td><td>no</td></tr><tr><td>auto-aof-rewrite-percentage</td><td>AOF重写触发百分比</td><td>100</td></tr><tr><td>auto-aof-rewrite-min-size</td><td>AOF重写触发最小大小</td><td>64mb</td></tr><tr><td>aof-load-truncated</td><td>是否加载被截断的AOF文件</td><td>yes</td></tr><tr><td>aof-use-rdb-preamble</td><td>是否使用混合持久化</td><td>yes（Redis 4.0+）</td></tr></tbody></table><h3 id="_3-7-aof的优缺点" tabindex="-1"><a class="header-anchor" href="#_3-7-aof的优缺点"><span>3.7 AOF的优缺点</span></a></h3><h4 id="_3-7-1-优点" tabindex="-1"><a class="header-anchor" href="#_3-7-1-优点"><span>3.7.1 优点</span></a></h4><ol><li><strong>数据安全性高</strong>：可以通过配置<code>appendfsync always</code>实现实时持久化</li><li><strong>文件可读性好</strong>：AOF文件是文本文件，可以直接查看和修改</li><li><strong>适合增量备份</strong>：可以通过追加新的命令来实现增量备份</li><li><strong>数据恢复准确</strong>：可以精确恢复到故障发生前的状态</li></ol><h4 id="_3-7-2-缺点" tabindex="-1"><a class="header-anchor" href="#_3-7-2-缺点"><span>3.7.2 缺点</span></a></h4><ol><li><strong>文件体积大</strong>：AOF文件通常比RDB文件大</li><li><strong>恢复速度慢</strong>：加载AOF文件的速度比RDB慢</li><li><strong>对性能影响大</strong>：写入策略越安全，对Redis性能的影响越大</li><li><strong>重写开销大</strong>：AOF重写需要消耗大量的内存和CPU资源</li></ol><h2 id="_4-rdb与aof的对比" tabindex="-1"><a class="header-anchor" href="#_4-rdb与aof的对比"><span>4. RDB与AOF的对比</span></a></h2><h3 id="_4-1-功能对比" tabindex="-1"><a class="header-anchor" href="#_4-1-功能对比"><span>4.1 功能对比</span></a></h3><table><thead><tr><th>特性</th><th>RDB</th><th>AOF</th></tr></thead><tbody><tr><td>持久化方式</td><td>内存快照</td><td>命令追加</td></tr><tr><td>文件格式</td><td>二进制</td><td>文本（RESP协议）</td></tr><tr><td>文件体积</td><td>小</td><td>大</td></tr><tr><td>恢复速度</td><td>快</td><td>慢</td></tr><tr><td>数据安全性</td><td>低（可能丢失数据）</td><td>高（可配置）</td></tr><tr><td>对性能影响</td><td>小（异步执行）</td><td>大（取决于写入策略）</td></tr><tr><td>适合场景</td><td>备份、灾难恢复</td><td>数据安全性要求高的场景</td></tr></tbody></table><h3 id="_4-2-适用场景" tabindex="-1"><a class="header-anchor" href="#_4-2-适用场景"><span>4.2 适用场景</span></a></h3><h4 id="_4-2-1-选择rdb的场景" tabindex="-1"><a class="header-anchor" href="#_4-2-1-选择rdb的场景"><span>4.2.1 选择RDB的场景</span></a></h4><ol><li><strong>对数据安全性要求不高</strong>：可以接受一定时间内的数据丢失</li><li><strong>需要快速恢复数据</strong>：RDB文件加载速度快</li><li><strong>需要定期备份</strong>：RDB文件适合用于定期备份</li><li><strong>资源有限</strong>：RDB对Redis性能的影响较小</li></ol><h4 id="_4-2-2-选择aof的场景" tabindex="-1"><a class="header-anchor" href="#_4-2-2-选择aof的场景"><span>4.2.2 选择AOF的场景</span></a></h4><ol><li><strong>对数据安全性要求高</strong>：需要确保数据不丢失或丢失最少</li><li><strong>需要精确恢复数据</strong>：AOF可以精确恢复到故障发生前的状态</li><li><strong>需要可读性好的持久化文件</strong>：AOF文件是文本文件，便于查看和修改</li></ol><h2 id="_5-混合持久化" tabindex="-1"><a class="header-anchor" href="#_5-混合持久化"><span>5. 混合持久化</span></a></h2><h3 id="_5-1-混合持久化基本原理" tabindex="-1"><a class="header-anchor" href="#_5-1-混合持久化基本原理"><span>5.1 混合持久化基本原理</span></a></h3><p>Redis 4.0引入了混合持久化机制，结合了RDB和AOF的优点。混合持久化生成的AOF文件由两部分组成：</p><ol><li><strong>RDB部分</strong>：文件开头包含一个RDB格式的快照</li><li><strong>AOF部分</strong>：文件结尾包含RDB快照之后的所有写命令</li></ol>`,34)),e(i,{code:"eJxLL0osyFAIceFSAALH6Gfbtz+d0PGsp/HJztanPdMc/d2eTWt/sntbrIKurp2CU3SQi9OzBXue7ul/un/189blsWBtTmBJ52iQaojkxL1Pdi+J5QIA1PUrzg=="}),s[5]||(s[5]=a('<h3 id="_5-2-混合持久化的优势" tabindex="-1"><a class="header-anchor" href="#_5-2-混合持久化的优势"><span>5.2 混合持久化的优势</span></a></h3><ol><li><strong>恢复速度快</strong>：开头的RDB部分可以快速加载大部分数据</li><li><strong>数据安全性高</strong>：结尾的AOF部分可以精确恢复最新的数据</li><li><strong>文件体积小</strong>：比纯AOF文件小</li></ol><h3 id="_5-3-混合持久化配置" tabindex="-1"><a class="header-anchor" href="#_5-3-混合持久化配置"><span>5.3 混合持久化配置</span></a></h3><p>混合持久化通过<code>aof-use-rdb-preamble</code>参数控制：</p><div class="language-conf line-numbers-mode" data-highlighter="shiki" data-ext="conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-conf"><span class="line"><span>aof-use-rdb-preamble yes  # 开启混合持久化</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_5-4-混合持久化的工作流程" tabindex="-1"><a class="header-anchor" href="#_5-4-混合持久化的工作流程"><span>5.4 混合持久化的工作流程</span></a></h3>',6)),e(i,{code:"eJx9j1FOwkAQht89xV7AC/BAYm181MQbNLgxTRSwrZ7AlopUJCqIaEKJWhJiJT5ooCW9TGeKt3C6VUnThH2Z2Znv3/9fnZ+c8mqFy6pyqCnHG4xOXdEMtaLWlarBto9UTkXRGfgjtL+SyXuB2ecHqp4iosFHB5ou9MdFTpYEJUs4duGpVwC29nZSgMovIIgswma5LJ4vMbD60FnEwbPYiuFqiRfe0m1l+zjy8XYGlglv9zmWDEpsGS2gOcxIsKc0S8IbsD6gNRfwbs3grHbGtUxGAu8V2h3ivhsOZci7yxIFswcQzKmFaJKYXgbI0p9hmtt8SX8/DCFs490UHZ+csZuaY7cRB59CQ7d8SNLEs0u4vkoezv8Dr5PhIEJnhD1vRfwADlXbzQ=="}),s[6]||(s[6]=a(`<h2 id="_6-持久化配置最佳实践" tabindex="-1"><a class="header-anchor" href="#_6-持久化配置最佳实践"><span>6. 持久化配置最佳实践</span></a></h2><h3 id="_6-1-生产环境配置建议" tabindex="-1"><a class="header-anchor" href="#_6-1-生产环境配置建议"><span>6.1 生产环境配置建议</span></a></h3><h4 id="_6-1-1-仅使用rdb" tabindex="-1"><a class="header-anchor" href="#_6-1-1-仅使用rdb"><span>6.1.1 仅使用RDB</span></a></h4><div class="language-conf line-numbers-mode" data-highlighter="shiki" data-ext="conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-conf"><span class="line"><span>save 900 1</span></span>
<span class="line"><span>save 300 10</span></span>
<span class="line"><span>save 60 10000</span></span>
<span class="line"><span>dbfilename dump.rdb</span></span>
<span class="line"><span>dir /var/lib/redis</span></span>
<span class="line"><span>stop-writes-on-bgsave-error yes</span></span>
<span class="line"><span>rdbcompression yes</span></span>
<span class="line"><span>rdbchecksum yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-1-2-仅使用aof" tabindex="-1"><a class="header-anchor" href="#_6-1-2-仅使用aof"><span>6.1.2 仅使用AOF</span></a></h4><div class="language-conf line-numbers-mode" data-highlighter="shiki" data-ext="conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-conf"><span class="line"><span>appendonly yes</span></span>
<span class="line"><span>appendfilename appendonly.aof</span></span>
<span class="line"><span>dir /var/lib/redis</span></span>
<span class="line"><span>appendfsync everysec</span></span>
<span class="line"><span>no-appendfsync-on-rewrite yes</span></span>
<span class="line"><span>auto-aof-rewrite-percentage 100</span></span>
<span class="line"><span>auto-aof-rewrite-min-size 64mb</span></span>
<span class="line"><span>aof-load-truncated yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-1-3-使用混合持久化" tabindex="-1"><a class="header-anchor" href="#_6-1-3-使用混合持久化"><span>6.1.3 使用混合持久化</span></a></h4><div class="language-conf line-numbers-mode" data-highlighter="shiki" data-ext="conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-conf"><span class="line"><span>appendonly yes</span></span>
<span class="line"><span>appendfilename appendonly.aof</span></span>
<span class="line"><span>dir /var/lib/redis</span></span>
<span class="line"><span>appendfsync everysec</span></span>
<span class="line"><span>no-appendfsync-on-rewrite yes</span></span>
<span class="line"><span>auto-aof-rewrite-percentage 100</span></span>
<span class="line"><span>auto-aof-rewrite-min-size 64mb</span></span>
<span class="line"><span>aof-load-truncated yes</span></span>
<span class="line"><span>aof-use-rdb-preamble yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-数据备份策略" tabindex="-1"><a class="header-anchor" href="#_6-2-数据备份策略"><span>6.2 数据备份策略</span></a></h3><ol><li><p><strong>定期备份RDB文件</strong>：</p><ul><li>每天凌晨执行BGSAVE命令创建RDB文件</li><li>将RDB文件备份到远程服务器或云存储</li></ul></li><li><p><strong>定期备份AOF文件</strong>：</p><ul><li>每周备份一次AOF文件</li><li>确保备份的AOF文件是完整的</li></ul></li><li><p><strong>制定灾难恢复计划</strong>：</p><ul><li>定期测试数据恢复流程</li><li>确保备份文件的可用性和完整性</li></ul></li></ol><h2 id="_7-数据恢复与故障处理" tabindex="-1"><a class="header-anchor" href="#_7-数据恢复与故障处理"><span>7. 数据恢复与故障处理</span></a></h2><h3 id="_7-1-数据恢复流程" tabindex="-1"><a class="header-anchor" href="#_7-1-数据恢复流程"><span>7.1 数据恢复流程</span></a></h3>`,12)),e(i,{code:"eJxLL0osyFAIceFSAALH6KcT1j/tWhGUmpJZHKugq2un4FT9bHHDs/lLX7b2Pt+7rhaszAkkU/Nkd2uQi1ONgnP0064FL/buBXKeTWt/sntbLKoiR3+3GgUXqCIgB1PRs+3bn07oeNbT+GRn69OeaTUKrlDVEAk0Pc5gd7lFP2tc9HRJ79N1Pc86JkBkXCAyYLYrlA0AVNBgLw=="}),s[7]||(s[7]=a('<h3 id="_7-2-手动恢复数据" tabindex="-1"><a class="header-anchor" href="#_7-2-手动恢复数据"><span>7.2 手动恢复数据</span></a></h3><h4 id="_7-2-1-使用rdb文件恢复" tabindex="-1"><a class="header-anchor" href="#_7-2-1-使用rdb文件恢复"><span>7.2.1 使用RDB文件恢复</span></a></h4><ol><li>停止Redis服务器</li><li>将备份的RDB文件复制到Redis的数据目录</li><li>启动Redis服务器，Redis会自动加载RDB文件</li></ol><h4 id="_7-2-2-使用aof文件恢复" tabindex="-1"><a class="header-anchor" href="#_7-2-2-使用aof文件恢复"><span>7.2.2 使用AOF文件恢复</span></a></h4><ol><li>停止Redis服务器</li><li>将备份的AOF文件复制到Redis的数据目录</li><li>启动Redis服务器，Redis会自动加载AOF文件</li></ol><h3 id="_7-3-aof文件损坏修复" tabindex="-1"><a class="header-anchor" href="#_7-3-aof文件损坏修复"><span>7.3 AOF文件损坏修复</span></a></h3><p>如果AOF文件损坏，可以使用Redis提供的<code>redis-check-aof</code>工具进行修复：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">redis-check-aof</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --fix</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> appendonly.aof</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_7-4-数据恢复优先级" tabindex="-1"><a class="header-anchor" href="#_7-4-数据恢复优先级"><span>7.4 数据恢复优先级</span></a></h3><p>当同时存在RDB和AOF文件时，Redis的恢复优先级为：</p><ol><li>如果开启了AOF持久化，优先使用AOF文件恢复</li><li>如果未开启AOF持久化，使用RDB文件恢复</li></ol><h2 id="_8-性能优化" tabindex="-1"><a class="header-anchor" href="#_8-性能优化"><span>8. 性能优化</span></a></h2><h3 id="_8-1-持久化对性能的影响" tabindex="-1"><a class="header-anchor" href="#_8-1-持久化对性能的影响"><span>8.1 持久化对性能的影响</span></a></h3><ol><li><p><strong>RDB的性能影响</strong>：</p><ul><li>BGSAVE命令会fork子进程，消耗内存和CPU资源</li><li>当数据量较大时，fork操作可能导致Redis短暂阻塞</li></ul></li><li><p><strong>AOF的性能影响</strong>：</p><ul><li>写入策略越安全，对Redis性能的影响越大</li><li>AOF重写会消耗大量内存和CPU资源</li></ul></li></ol><h3 id="_8-2-性能优化策略" tabindex="-1"><a class="header-anchor" href="#_8-2-性能优化策略"><span>8.2 性能优化策略</span></a></h3><h4 id="_8-2-1-rdb性能优化" tabindex="-1"><a class="header-anchor" href="#_8-2-1-rdb性能优化"><span>8.2.1 RDB性能优化</span></a></h4><ol><li><strong>合理配置save参数</strong>：避免过于频繁的RDB持久化</li><li><strong>选择合适的时间执行BGSAVE</strong>：在业务低峰期执行</li><li><strong>确保有足够的内存</strong>：避免fork子进程时内存不足</li><li><strong>关闭RDB压缩</strong>：如果CPU资源紧张，可以关闭<code>rdbcompression</code></li></ol><h4 id="_8-2-2-aof性能优化" tabindex="-1"><a class="header-anchor" href="#_8-2-2-aof性能优化"><span>8.2.2 AOF性能优化</span></a></h4><ol><li><strong>选择合适的写入策略</strong>：生产环境推荐使用<code>everysec</code></li><li><strong>开启no-appendfsync-on-rewrite</strong>：AOF重写时停止同步，提高性能</li><li><strong>合理配置重写参数</strong>：避免过于频繁的AOF重写</li><li><strong>使用混合持久化</strong>：结合RDB和AOF的优点</li></ol><h4 id="_8-2-3-通用性能优化" tabindex="-1"><a class="header-anchor" href="#_8-2-3-通用性能优化"><span>8.2.3 通用性能优化</span></a></h4><ol><li><strong>使用高性能存储设备</strong>：使用SSD存储持久化文件</li><li><strong>分离持久化文件目录</strong>：将持久化文件存储在单独的磁盘上</li><li><strong>限制Redis内存使用</strong>：避免数据量过大导致持久化性能下降</li><li><strong>监控持久化状态</strong>：定期监控RDB和AOF的执行情况</li></ol><h2 id="_9-redis-7-0-持久化改进" tabindex="-1"><a class="header-anchor" href="#_9-redis-7-0-持久化改进"><span>9. Redis 7.0+持久化改进</span></a></h2><h3 id="_9-1-aof优化" tabindex="-1"><a class="header-anchor" href="#_9-1-aof优化"><span>9.1 AOF优化</span></a></h3><p>Redis 7.0对AOF持久化进行了多项优化：</p><ol><li><strong>AOF多部分文件</strong>：将AOF文件分为基础文件和增量文件</li><li><strong>AOF重写优化</strong>：减少AOF重写的内存消耗</li><li><strong>AOF加载优化</strong>：提高AOF文件的加载速度</li></ol><h3 id="_9-2-rdb优化" tabindex="-1"><a class="header-anchor" href="#_9-2-rdb优化"><span>9.2 RDB优化</span></a></h3><p>Redis 7.0对RDB持久化进行了以下优化：</p><ol><li><strong>RDB版本升级</strong>：支持更多数据类型和特性</li><li><strong>RDB压缩优化</strong>：提高RDB文件的压缩效率</li></ol><h2 id="_10-总结" tabindex="-1"><a class="header-anchor" href="#_10-总结"><span>10. 总结</span></a></h2><p>Redis提供了两种主要的持久化方式：RDB和AOF。RDB通过创建内存快照来持久化数据，文件体积小，恢复速度快，但数据安全性较低；AOF通过追加写命令来持久化数据，数据安全性高，但文件体积大，恢复速度慢。</p><p>Redis 4.0引入的混合持久化机制结合了RDB和AOF的优点，提供了更好的性能和数据安全性。在实际应用中，应该根据业务需求和数据安全性要求选择合适的持久化方式。</p><p>无论选择哪种持久化方式，都应该制定合理的备份策略和灾难恢复计划，确保数据的安全性和可用性。同时，还需要关注持久化对Redis性能的影响，采取适当的优化措施，保证Redis的正常运行。</p><h2 id="_11-参考资料" tabindex="-1"><a class="header-anchor" href="#_11-参考资料"><span>11. 参考资料</span></a></h2><ol><li>Redis官方文档：<a href="https://redis.io/documentation" target="_blank" rel="noopener noreferrer">https://redis.io/documentation</a></li><li>《Redis设计与实现》</li><li>Redis源码：<a href="https://github.com/redis/redis" target="_blank" rel="noopener noreferrer">https://github.com/redis/redis</a></li><li>Redis命令参考：<a href="https://redis.io/commands" target="_blank" rel="noopener noreferrer">https://redis.io/commands</a></li></ol>',34))])}const g=n(r,[["render",o]]),b=JSON.parse('{"path":"/posts/redis/03-Redis%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html","title":"Redis持久化机制详解","lang":"en-US","frontmatter":{"title":"Redis持久化机制详解","tag":["Redis","持久化","RDB","AOF","数据恢复"],"category":"Redis","description":"详细介绍Redis的RDB和AOF持久化机制、原理、配置及适用场景","date":"2024-01-19T00:00:00.000Z","author":"nikola","icon":"paw","isOriginal":false,"sticky":false,"timeline":true,"article":true,"star":false,"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Redis持久化机制详解\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-01-19T00:00:00.000Z\\",\\"dateModified\\":\\"2025-12-07T16:02:41.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"nikola\\"}]}"],["meta",{"property":"og:url","content":"https://nikolazhang.github.io/posts/redis/03-Redis%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html"}],["meta",{"property":"og:title","content":"Redis持久化机制详解"}],["meta",{"property":"og:description","content":"详细介绍Redis的RDB和AOF持久化机制、原理、配置及适用场景"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2025-12-07T16:02:41.000Z"}],["meta",{"property":"article:author","content":"nikola"}],["meta",{"property":"article:tag","content":"数据恢复"}],["meta",{"property":"article:tag","content":"AOF"}],["meta",{"property":"article:tag","content":"RDB"}],["meta",{"property":"article:tag","content":"持久化"}],["meta",{"property":"article:tag","content":"Redis"}],["meta",{"property":"article:published_time","content":"2024-01-19T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-12-07T16:02:41.000Z"}]]},"git":{"createdTime":1765117689000,"updatedTime":1765123361000,"contributors":[{"name":"我小叮当","username":"","email":"nikolazhang@163.com","commits":3}]},"readingTime":{"minutes":12.95,"words":3885},"filePathRelative":"posts/redis/03-Redis持久化机制详解.md"}');export{g as comp,b as data};
