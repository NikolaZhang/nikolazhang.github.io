import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,e as n,o as e}from"./app-Cds-x6Nj.js";const t="/assets/image-2-BqKfqSJx.png",l="/assets/image-3-BSSpA9QE.png",h="/assets/image-4-BGVay6rV.png",p="/assets/image-11-D4CLq4Ob.png",k="/assets/image-10-CIEU0JHi.png",r={};function d(o,s){return e(),a("div",null,[...s[0]||(s[0]=[n('<blockquote><p>使用gitee触发webhook需要外网地址，我们只有内网环境，那么本地如何触发构建呢？这篇文章尝试通过本地添加git hook脚本，在提交之后发送构建请求。</p></blockquote><h2 id="gitee中的webhook" tabindex="-1"><a class="header-anchor" href="#gitee中的webhook"><span>gitee中的webhook</span></a></h2><p>打开项目中的管理菜单，可以找到WebHooks。</p><p><img src="'+t+'" alt="Alt text"></p><p>上图中的账号密码为Jenkins用户的账号密码。</p><p>尝试发送一个请求，看看请求的格式，之后通过本地发送请求触发构建。</p><p><img src="'+l+'" alt="Alt text"></p><h2 id="本地模拟hook请求" tabindex="-1"><a class="header-anchor" href="#本地模拟hook请求"><span>本地模拟hook请求</span></a></h2><p>请求地址、header、body复制到postman中。</p><p><img src="'+h+`" alt="Alt text"></p><p>之后删除一些属性，发送请求。经过简化，我们发送信息需要包含下面的部分即可。</p><p>header需要包含的内容：</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-shell"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">X-Git-Oschina-Event:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Push</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Hook</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">X-Gitee-Event:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Push</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Hook</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">User-Agent:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> git-oschina-hook</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">X-Gitee-Ping:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Content-Type:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> application/json</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>body需要包含的内容：</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-json"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    &quot;commits&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: [</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">            &quot;message&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;BUILD&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ],</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    &quot;project&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        &quot;git_http_url&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;https://gitee.com/NikolaZhang/communicate.git&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        &quot;id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">8278595</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        &quot;name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;communicate&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        &quot;namespace&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;NikolaZhang&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        &quot;ssh_url&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;git@gitee.com:NikolaZhang/communicate.git&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    },</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    &quot;ref&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;refs/heads/develop&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    &quot;sender&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        &quot;name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;我小叮当&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    },</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    &quot;user_name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;我小叮当&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面body中的id，为一个数字即可。如果你希望根据其他信息，进行触发构建，可能需要更多参数。我们使用提交信息中的message进行匹配构建，这在<code>【安卓服务器】jenkins项目构建配置</code>文中提及。</p><h2 id="本地添加git-hook脚本" tabindex="-1"><a class="header-anchor" href="#本地添加git-hook脚本"><span>本地添加git hook脚本</span></a></h2><p>在本地项目的<code>.git/hooks</code>目录中，新建<code>pre-push</code>文件，将下面的内容保存到文件中。</p><p>注意：project中的内容以及其他信息，需要按照自己的实际情况配置。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#!/bin/sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">last_message</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">git</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> log</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -1</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --format=%s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">body</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;{</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;commits&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        {</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;message&quot;: &quot;&#39;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$last_message</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        }</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    ],</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;project&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        &quot;git_http_url&quot;: &quot;https://gitee.com/NikolaZhang/communicate.git&quot;,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        &quot;id&quot;: 8278595,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        &quot;name&quot;: &quot;communicate&quot;,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        &quot;namespace&quot;: &quot;NikolaZhang&quot;,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        &quot;ssh_url&quot;: &quot;git@gitee.com:NikolaZhang/communicate.git&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    },</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;ref&quot;: &quot;refs/heads/develop&quot;,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;sender&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        &quot;name&quot;: &quot;我小叮当&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    },</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;user_name&quot;: &quot;我小叮当&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">}</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">url</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;http://admin:1234@192.168.137.221:18080/gitee-project/communicate&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -X</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> POST</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -H</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Content-Type: application/json&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -H</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;X-Git-Oschina-Event: Push Hook&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -H</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;X-Gitee-Event: Push Hook&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -H</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;User-Agent: git-oschina-hook&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -H</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;X-Gitee-Ping: false&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">    -d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$body</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> $url</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">exit</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>脚本中url需要改为Jenkins提示中的url。</p><p><img src="`+p+'" alt="Alt text"></p><p>打开git bash终端，测试脚本是否可以正常运行。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pre-push</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">bash</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>当消息正常发送，并收到请求结果，则说明脚本可以正常运行。</p><p><img src="'+k+'" alt="Alt text"></p><p>这样以后我们向远程push代码时，本地git就会触发hook，给内网的Jenkins发送构建请求。</p>',27)])])}const u=i(r,[["render",d]]),m=JSON.parse('{"path":"/posts/android/%E6%9C%AC%E5%9C%B0webhook%E5%A6%82%E4%BD%95%E8%A7%A6%E5%8F%91%E6%9E%84%E5%BB%BA.html","title":"【安卓服务器】本地webhook如何触发构建","lang":"en-US","frontmatter":{"title":"【安卓服务器】本地webhook如何触发构建","tag":["安卓","termux","Jenkins","webhook"],"category":"安卓服务器","description":"使用gitee触发webhook需要外网地址，我们只有内网环境，那么本地如何触发构建呢？","banner":"http://image.nikolazhang.top/wallhaven-nrwq11.jpg","date":"2024-01-12T00:00:00.000Z","author":"nikola","icon":"article","isOriginal":true,"sticky":false,"timeline":true,"article":true,"star":false,"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"【安卓服务器】本地webhook如何触发构建\\",\\"image\\":[\\"http://image.nikolazhang.top/wallhaven-nrwq11.jpg\\"],\\"datePublished\\":\\"2024-01-12T00:00:00.000Z\\",\\"dateModified\\":\\"2024-12-31T08:40:08.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"nikola\\"}]}"],["meta",{"property":"og:url","content":"https://nikolazhang.github.io/posts/android/%E6%9C%AC%E5%9C%B0webhook%E5%A6%82%E4%BD%95%E8%A7%A6%E5%8F%91%E6%9E%84%E5%BB%BA.html"}],["meta",{"property":"og:title","content":"【安卓服务器】本地webhook如何触发构建"}],["meta",{"property":"og:description","content":"使用gitee触发webhook需要外网地址，我们只有内网环境，那么本地如何触发构建呢？"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"http://image.nikolazhang.top/wallhaven-nrwq11.jpg"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2024-12-31T08:40:08.000Z"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"http://image.nikolazhang.top/wallhaven-nrwq11.jpg"}],["meta",{"name":"twitter:image:alt","content":"【安卓服务器】本地webhook如何触发构建"}],["meta",{"property":"article:author","content":"nikola"}],["meta",{"property":"article:tag","content":"webhook"}],["meta",{"property":"article:tag","content":"Jenkins"}],["meta",{"property":"article:tag","content":"termux"}],["meta",{"property":"article:tag","content":"安卓"}],["meta",{"property":"article:published_time","content":"2024-01-12T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-12-31T08:40:08.000Z"}]]},"git":{"createdTime":1705052564000,"updatedTime":1735634408000,"contributors":[{"name":"我小叮当","username":"","email":"nikolazhang@163.com","commits":6}]},"readingTime":{"minutes":2.18,"words":654},"filePathRelative":"posts/android/本地webhook如何触发构建.md"}');export{u as comp,m as data};
